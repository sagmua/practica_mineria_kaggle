---
title: "Knn 2"
author: "Carmen Biedma Rodriguez"
date: "18 de febrero de 2019"
output: pdf_document
---

```{r}
library(dplyr)
library(Hmisc)
library(caret)
library(mice)
library(VIM)
library(class)
library(outliers)
library(ggplot2)
library(mvoutlier)
library(FSelector)
library(corrplot)
library(NoiseFiltersR)

source("../funcionesAux.R")

generarModelo <- function(train,test,k=3){
  pred  <- knn(train = train[,-ncol(train)], test = test,cl = train$C, k)
  pred
}
```

```{r}
datos <- read.csv("../train.csv",na.strings=c(" ","NA","?"))
test <- read.csv("../test.csv",na.strings=c(" ","NA","?"))
```

#MODELO 1 --------------------------------------------------------------------------------------------
#IMPUTACION DE VALORES PERDIDOS

```{r}
imputados.amelia <- Amelia::amelia(datos,m=1,parallel="multicore",noms="C")
incompletos.amelia <- mice::nic(imputados.amelia$imputations$imp1)
completos.amelia <- mice::ncc(imputados.amelia$imputations$imp1)
cat("COMPLETOS = ", completos.amelia, " INCOMPLETOS = ",incompletos.amelia)
datos <- imputados.amelia$imputations$imp1
```

#ESCALADO Y CENTRADO DE LOS DATOS

```{r}
datosPrep <- caret::preProcess(datos[,-ncol(datos)],method = c("center","scale"))
datos[,-ncol(datos)] <- predict(datosPrep,datos[,-ncol(datos)])
datosPrep <- caret::preProcess(test,method = c("center","scale"))
test <- predict(datosPrep,test)
```


```{r}
boxplot(datos)
```


```{r}
resOutliers <- mvoutlier::uni.plot(datos[,c(1:10)])
datos <- datos[!resOutliers$outliers, ]
resOutliers <- mvoutlier::uni.plot(datos[,c(11:20)])
datos <- datos[!resOutliers$outliers, ]
resOutliers <- mvoutlier::uni.plot(datos[,c(21:30)])
datos <- datos[!resOutliers$outliers, ]
resOutliers <- mvoutlier::uni.plot(datos[,c(31:40)])
datos <- datos[!resOutliers$outliers, ]
```

```{r}
boxplot(datos)
```

```{r}
table(datos$C)
```

Ruido

```{r,echo=FALSE}
datos$C <- as.factor(datos$C)
out <- IPF(C~., data = datos,s = 3)
summary(out, explicit =TRUE)
out$cleanData
datosSinRuido <- datos[setdiff(1:nrow(datos),out$remIdx),]
cat("Se han eliminado ", dim(datos)[1]- dim(datosSinRuido)[1], "instancias")
datos <- datosSinRuido
```



Particionado

```{r}
inTrain <- caret::createDataPartition(y = datos$C, p = .75, list = FALSE)

datos.train <- datos[ inTrain,]
datos.test <- datos[-inTrain,]
```

GENERAR MODELO 1

```{r}
train_pred <- generarModelo(train = datos.train, test = datos.test[,-ncol(datos.test)],k=3)
accuracy<- precision(train_pred,datos.test$C)
accuracy
```

Cálculo de etiquetas del test

```{r}
test_pred <- generarModelo(train = datos.train, test = test,3)
```


```{r}
generarEnvio(y=test_pred,file="envio_1_fichero2.csv")
```


#MODELO 2 --------------------------------------------------------------------------------------------
#Ahora con seleccion de caracteristicas: da menos accuracy, por lo que me quedo con todas las variables


```{r}
m <- cor(datos[,-ncol(datos)])
correlados <- findCorrelation(m, cutoff = 0.8)
datos <- datos[,-correlados]
test <- test[,-correlados]
```


```{r}
inTrain <- caret::createDataPartition(y = datos$C, p = .75, list = FALSE)

datos.train <- datos[ inTrain,]
datos.test <- datos[-inTrain,]
```

GENERAR MODELO 2: 
MODELO 2.1:se ha probado con todos los datos de train para predecir en vez de solo la particion de train hecha
MODELO 2.3: se ha probado un 1nn -> da peor resultado todavia.


```{r}
train_pred <- generarModelo(train = datos.train, test = datos.test[,-ncol(datos.test)],k=1)
accuracy<- precision(train_pred,datos.test$C)
accuracy
```

Cálculo de etiquetas del test

```{r}
test_pred <- generarModelo(train = datos, test = test,1)
```


```{r}
generarEnvio(y=test_pred,file="envio2.2_fichero2.csv")
```

#MODELO 3 --------------------------------------------------------------------------------------------
#Tratar desbalanceo

Datos: imputacion, normalizacion,outliers,ruido

```{r}
dim(datos)
```

```{r}
table(datos$C)
```

```{r}
datos.smote<- oversample(datos,ratio=0.65, method="SMOTE",classAttr = "C")
table(datos.smote$C)
```




```{r}
inTrain <- caret::createDataPartition(y = datos.smote$C, p = .75, list = FALSE)

datos.train <- datos.smote[inTrain,]
datos.test <- datos.smote[-inTrain,]
```

GENERAR MODELO 3: Oversampling con smote

```{r}
train_pred <- generarModelo(train = datos.train, test = datos.test[,-ncol(datos.test)],k=3)
accuracy<- precision(train_pred,datos.test$C)
accuracy
```

Cálculo de etiquetas del test

```{r}
test_pred <- generarModelo(train = datos, test = test,3)
```


```{r}
generarEnvio(y=test_pred,file="envio3_fichero2.csv")
```

#MODELO 4 --------------------------------------------------------------------------------------------


```{r}
datos <- read.csv("../train.csv",na.strings=c(" ","NA","?"))
test <- read.csv("../test.csv",na.strings=c(" ","NA","?"))
```


```{r}
imputados.amelia <- Amelia::amelia(datos,m=1,parallel="multicore",noms="C")
incompletos.amelia <- mice::nic(imputados.amelia$imputations$imp1)
completos.amelia <- mice::ncc(imputados.amelia$imputations$imp1)
cat("COMPLETOS = ", completos.amelia, " INCOMPLETOS = ",incompletos.amelia)
datos <- imputados.amelia$imputations$imp1
```


#ESCALADO Y CENTRADO DE LOS DATOS

```{r}
datosPrep <- caret::preProcess(datos[,-ncol(datos)],method = c("center","scale"))
datos[,-ncol(datos)] <- predict(datosPrep,datos[,-ncol(datos)])
datosPrep <- caret::preProcess(test,method = c("center","scale"))
test <- predict(datosPrep,test)
```



```{r,echo=FALSE}
datos$C <- as.factor(datos$C)
out <- IPF(C~., data = datos,s = 3)
summary(out, explicit =TRUE)
out$cleanData
datosSinRuido <- datos[setdiff(1:nrow(datos),out$remIdx),]
cat("Se han eliminado ", dim(datos)[1]- dim(datosSinRuido)[1], "instancias")
datos <- datosSinRuido
```

```{r}
table(datos$C)
balanced <- ubUnder(X=datos[,-ncol(datos)], Y= datos$C, perc = 40, method = "percPos")
datos.undersampling <- balanced$X
datos.undersampling$C <- balanced$Y
table(datos.undersampling$C)
```


```{r}
inTrain <- caret::createDataPartition(y = datos.undersampling$C, p = .75, list = FALSE)

datos.train <- datos.undersampling[inTrain,]
datos.test <- datos.undersampling[-inTrain,]
```

GENERAR MODELO 4: undersampling

```{r}
train_pred <- generarModelo(train = datos.train, test = datos.test[,-ncol(datos.test)],k=3)
accuracy<- precision(train_pred,datos.test$C)
accuracy
```


GENERAR MODELO 5: undersampling con eliminacion de outliers

```{r}
resOutliers <- mvoutlier::uni.plot(datos.undersampling[,c(1:10)])
datos.sinoutliers <- datos.undersampling[!resOutliers$outliers, ]
resOutliers <- mvoutlier::uni.plot(datos.undersampling[,c(11:20)])
datos.sinoutliers  <- datos.undersampling[!resOutliers$outliers, ]
resOutliers <- mvoutlier::uni.plot(datos.undersampling[,c(21:30)])
datos.sinoutliers  <- datos.undersampling[!resOutliers$outliers, ]
resOutliers <- mvoutlier::uni.plot(datos.undersampling[,c(31:40)])
datos.sinoutliers  <- datos.undersampling[!resOutliers$outliers, ]
```



GENERAR MODELO 4: undersampling

```{r}
inTrain <- caret::createDataPartition(y = datos.sinoutliers$C, p = .75, list = FALSE)

datos.train <- datos.sinoutliers[inTrain,]
datos.test <- datos.sinoutliers[-inTrain,]
```

```{r}
train_pred <- generarModelo(train = datos.train, test = datos.test[,-ncol(datos.test)],k=3)
accuracy<- precision(train_pred,datos.test$C)
accuracy
```